<!--
@homepage https://github.com/stevenrskelton/sortable-table
@element datatables-ajax
@demo http://files.stevenskelton.ca/sortable-table/examples/datatables-ajax
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element hidden
	name="datatables-ajax"
	attributes="url withCredentials start length search sortColumn sortDescending columns data recordsTotal"
>
<script>
	Polymer('datatables-ajax', {
		url: null,
		withCredentials: false,
		start: 0,
		length: -1,
		search: "",
		sortColumn: null,
		sortDescending: false,
		columns: [],
		ajax: null,
		draw: 0,
		drawReceived: 0,
		ready: function() {
			var ajax = document.createElement('core-ajax');
			ajax.handleAs = 'json';
			var self = this;
			ajax.addEventListener("core-response", function(e){ self.handleResponse.call(self, e); });
			this.ajax = ajax;
			this.ajax.url = this.url;
			this.ajax.withCredentials = this.withCredentials;
			this.go();
		},
		handleResponse: function(e){
			var response = e.detail.response;
			if(response.draw > this.drawReceived){
				this.drawReceived = response.draw;
				this.recordsTotal = response.recordsTotal;
				this.data = response.data;
			}
		},
		go: function(){
			this.draw++;
			var params = {
				draw: this.draw,
				start: this.start,
				length: this.length, /*,
				"search[value]": this.search,
				"search[regex]": false,*/
				"columns[0][data]": 0,
				"columns[0][name]": "",
				"columns[0][searchable]": true,
				"columns[0][orderable]": true,
				"columns[0][search][value]": "",
				"columns[0][search][regex]": false
			};
			if(this.columns.length>0){
				this.columns.forEach(function(element,i){
					params["columns[" + i + "][data]"] = element.data;
					params["columns[" + i + "][name]"] = element.name;
					params["columns[" + i + "][searchable]"] = true;
					params["columns[" + i + "][orderable]"] = true;
					params["columns[" + i + "][search][value]"] = "";
					params["columns[" + i + "][search][regex]"] = false;
				});
			}
			if(this.sortColumn){
				if(this.columns.length===0) alert('columns must be defined to define sort');
				else {
					var index = -1;
					var self = this;
					if(this.columns.every(function(element,i){
						if(element.name !== self.sortColumn) return true;
						else{
							index = i;
							return false;
						}
					})) alert('could not find column `' + this.sortColumn + '` in `columns`');
					else {
						params['order[0][column]'] = index;
						if(this.sortDescending) params['order[0][dir]'] = 'desc';
						else params['order[0][dir]'] = 'asc';
					}
				}
			}
			this.ajax.params = params;
			this.ajax.go();
		},
		startChanged: function(){ this.go(); },
		lengthChanged: function(){ this.go(); },
		sortColumnChanged: function(){ this.go(); },
		sortDescendingChanged: function(){ this.go(); }
	});
</script>
</polymer-element>
